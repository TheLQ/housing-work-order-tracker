<?xml version="1.0" encoding="UTF-8"?>
<!--

    Copyright (C) 2012 Leon Blakey <lord.quackstar at gmail.com>, RATS 2012

    This file is part of University of Louisville Housing WorkOrder System.

-->
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:wicket="http://wicket.apache.org/dtds.data/wicket-xhtml1.4-strict.dtd">
	<head>
		<title>Housing WorkOrders</title>
		<link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.1.0/css/bootstrap-combined.min.css" rel="stylesheet"/>
		<link href="css/main.css" rel="stylesheet"/>
	</head>
	<body style="padding-left: 4px; background-color: /*#F0F0F0*/white;">
		<div class="row-fluid">
			<div class="span6 form-inline" style="font-weight:bold; text-align: center">
				<form method="POST" action="processData?mode=form" id="mainForm">
					<!-- Header -->
					<div class="well" style="text-align: center">
						<h2>Housing - RATS Work Orders</h2>
						<h3>Ticket Manager</h3>
						Mode: <select id="modeSelect" name="modeSelect">
							<option value="Normal">Normal</option>
							<option value="Walkthrough">Walkthrough</option>
							<option value="AutoFix">AutoFix</option>
						</select>
						<select id="autoFix" name="autoFix" wicket:id="autoFix" style="display: none;" multiple="multiple"></select>
						<div class="alert alert-success" style="margin-bottom: 0; display: none;" id="topStatusBox">
							<button type="button" class="close" data-dismiss="alert">Ã—</button>
							<span id="topStatus"></span>
						</div>
					</div>
					<!-- Building and room select -->
					<div>
						<label>Building: <select name="building" id="building" wicket:id="building"></select></label>
						<label>Room: <input type="text" name="room" id="room" maxlength="3"/></label>
						<p>Status: <span id="roomStatus">Waiting for Input</span></p>
					</div>
					<!-- Issue Select template -->
					<div class="well well-small row-fluid issueBox" id="issueBox0">
						<div class="span6">
							<input type="hidden" name="sheetId" class="sheetId" value="-1"/>
							<!--Status Dropdown-->
							<input type="hidden" name="statusSelect" value="empty" class="statusSelect" />
							Issue #xx: <span class="issueInfo"></span>
							<select class="btn-danger issueStatus" style="width: 90px">
								<option>Open</option>
								<option>Waiting</option>
								<option>Closed</option>
							</select>
							<!--Issue Select Dropdown-->
							<p/><select wicket:id="issue" name="issue" class="issueSelect"></select>
						</div>
						<div class="span6 notesContainer">
							Notes:
							<div style="padding: 5px" class="notesBox" id="notesBox0">
								<input type="text" name="noteDate" class="noteDate" disabled="disabled"/>
								<textarea rows="3" name="note" class="note"/>
							</div>
							<button class="btn btn-info addNote"><i class="icon-plus"></i>Add Note</button>
							<button class="btn btn-warning removeNote" disabled="disabled"><i class="icon-remove"></i>Remove Note</button>
						</div>
					</div>
					<button id="addIssue" class="btn btn-info"><i class="icon-plus"></i>Add Issue</button>
					<button id="removeIssue" class="btn btn-warning" disabled="disabled"><i class="icon-plus"></i>Remove Issue</button>
					<button id="submit" type="submit" class="btn btn-success"><i class=" icon-ok-sign"></i>Submit</button>
					<br/>Submit Status: <span id="submitStatus">Waiting on input...</span>
				</form>
			</div>
			<div class="span6 well" wicket:id="hello">Part 2</div>
		</div>

		<!-- Libraries -->
		<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.8.0/jquery.min.js"></script>
		<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jqueryui/1.8.23/jquery-ui.min.js"></script>
		<script type="text/javascript" src="//malsup.github.com/jquery.form.js"></script>
		<script type="text/javascript" src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.1.1/js/bootstrap.min.js"></script>
		
		<!-- Our code -->
		<script type="text/javascript" src="js/form-utils.js"></script>
		<script type="text/javascript" src="js/form-duplication.js"></script>
		<script type="text/javascript" src="js/form-ajax.js"></script>
		<script type="text/javascript">
			$(document).ready(function(){
				//Load data from previous page
				if(getParameterByName("submitStatus") != "") {
					$("#topStatus").html(getParameterByName("submitStatus"));
					$("#topStatusBox").toggle(true);
					$("#modeSelect").val(getParameterByName("mode"));
					$("#autoFix").val(getParameterByName("autoFix").split(","));
					if(getParameterByName("building") != null)
						$("#building").val(getParameterByName("building"))
				}
								
				//AutoFixIt display toggle
				function toggleAutoFix() {
					if($("#modeSelect").val() == "Normal") {
						$("#autoFix").hide();
						//JQuery can't do this good apparently, so old-school time
						document.getElementById("autoFix").selectedIndex = -1;
					} else
						$("#autoFix").show();
				}
				//Show or hide based on preselected value
				toggleAutoFix();
				$('#modeSelect').change(function (e) {
					toggleAutoFix();
				});
				
				//AutoFixIt autoclosing issues
				function autoCloseIssues() {
					selectedIssues = $("#autoFix").val();
					$(".issueBox").each(function() {
						//Find any issues that should be autofixed
						if($.inArray($(this).find(".issueSelect").val(), selectedIssues) != -1) {
							setStatus($(this), "Closed");
							$(this).find(".issueInfo").html("(autofixed)")
						}
						//Find any issues that should no longer be autofixed
						else if($(this).find(".issueInfo").html() == "(autofixed)") {
							setStatus($(this), "Open")
							$(this).find(".issueInfo").html("")
						}
					})
				}
				$('#autoFix').change(autoCloseIssues);
				$(".issueSelect").change(autoCloseIssues);
				
				//Status Message
				function setStatus(issueBox, val) {
					console.log("Updating status for " + issueBox.attr("id"))
					select = $(".issueStatus", issueBox);
					select.val(val)
					
					//Set color based on value
					if(val == "Open")
						select.removeClass("btn-danger btn-warning btn-success").addClass("btn-danger");
					else if(val == "Waiting")
						select.removeClass("btn-danger btn-warning btn-success").addClass("btn-warning");
					else if(val == "Closed")
						select.removeClass("btn-danger btn-warning btn-success").addClass("btn-success")
				}
				$("#mainForm").on("change", ".issueStatus", function(event) {
					//event.preventDefault()
					setStatus($(this).closest(".issueBox"), $(this).val())
				});
			});
		</script>
	</body>
</html>