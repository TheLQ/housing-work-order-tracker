<?xml version="1.0" encoding="UTF-8"?>
<!--

    Copyright (C) 2012 Leon Blakey <lord.quackstar at gmail.com>, RATS 2012

    This file is part of University of Louisville Housing WorkOrder System.

-->
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:wicket="http://wicket.apache.org/dtds.data/wicket-xhtml1.4-strict.dtd">
	<head>
		<title>Housing WorkOrders</title>
		<link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.1.0/css/bootstrap-combined.min.css" rel="stylesheet"/>
		<link href="css/main.css" rel="stylesheet"/>
	</head>
	<body style="padding-left: 4px; background-color: /*#F0F0F0*/white;">
		<div class="row-fluid">
			<div class="span6 form-inline" style="font-weight:bold; text-align: center">
				<form method="POST" action="processData?mode=form" id="mainForm">
					<!-- Header -->
					<div class="well" style="text-align: center">
						<h2>Housing - RATS Work Orders</h2>
						<h3>Ticket Manager</h3>
						Issue Mode: <select id="modeSelect" name="modeSelect">
							<option value="Normal">Normal</option>
							<option value="Walkthrough">Walkthrough</option>
							<option value="AutoFix">AutoFix</option>
						</select>
						<select id="autoFix" name="autoFix" wicket:id="autoFix" style="display: none;" multiple="yes"></select>
					</div>
					<!-- Building and room select -->
					<div>
						<label>Building: <select name="building" id="building" wicket:id="building"></select></label>
						<label>Room: <input type="text" name="room" id="room" maxlength="3"/></label>
						<p>Status: <span id="roomStatus">Waiting for Input</span></p>
					</div>
					<!-- Issue Select template -->
					<div class="well well-small row-fluid issueBox" id="issueBox">
						<div class="span6">
							<input type="hidden" name="sheetId" id="sheetId" value="-1" style="display: none"/>
							<!--Status Dropdown-->
							Issue #xx: <span class="issueStatus"></span>
							<div class="btn-group">
								<button class="btn btn-danger dropdown-toggle" data-toggle="dropdown">
									<span class="statusName">Open</span>
									<span class="caret"></span>
								</button>
								<ul class="dropdown-menu">
									<li><a href="#" class="statusOption">Open</a></li>
									<li><a href="#" class="statusOption">Waiting</a></li>
									<li><a href="#" class="statusOption">Closed</a></li>
								</ul>
							</div>
							<!--Issue Select Dropdown-->
							<p/><select wicket:id="issue" name="issue" id="issue" class="issueSelect"></select>
						</div>
						<div class="span6" id="notesContainer">
							Notes:
							<div id="notesBox" style="padding: 5px" class="notesBox">
								<textarea rows="3" name="note" id="note" class="notesArea"/>
							</div>
							<button id="addNote" class="btn btn-info"><i class="icon-plus"></i>Add Note</button>
							<button id="removeNote" class="btn btn-warning"><i class="icon-remove"></i>Remove Note</button>
						</div>
					</div>
					<button id="addIssue" class="btn btn-info"><i class="icon-plus"></i>Add Issue</button>
					<button id="removeIssue" class="btn btn-info" style="display: none;"><i class="icon-plus"></i>Remove Issue</button>
					<button id="submit" type="submit" class="btn btn-success"><i class=" icon-ok-sign"></i>Submit</button>
					<br/>Submit Status: <span id="submitStatus">Waiting on input...</span>
				</form>
			</div>
			<div class="span6 well" wicket:id="hello">Part 2</div>
		</div>


		<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.8.0/jquery.min.js"></script>
		<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jqueryui/1.8.23/jquery-ui.min.js"></script>
		<script type="text/javascript" src="js/jquery-dynamic-form.js"></script>
		<script type="text/javascript" src="//malsup.github.com/jquery.form.js"></script>
		<script type="text/javascript" src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.1.1/js/bootstrap.min.js"></script>
		<script type="text/javascript">
			$(document).ready(function(){
				//Issue Duplication
				var dynamicIssue = $("#issueBox").dynamicForm("#addIssue", "#removeIssue", 
				{createColor:'yellow',	removeColor: 'red', afterClone: postIssueClone});
				$("#notesBox").dynamicForm("#addNote", "#removeNote", {createColor:'yellow',	removeColor: 'red'});
				
				//Form resetting
				function resetForm() {
					//Remove all other issue boxes
					console.log("About to reset form")
					totalIssues = $(".issueBox").length;
					if(totalIssues > 1)
						for(i = 1; i < totalIssues; i++)
							$("#removeIssue").click();
					
					//Remove extra notes in first box
					counter = 0;
					firstIssueBox = $(".issueBox").first();
					$(".notesBox", firstIssueBox).each(function(index) {
						if(index != 0) {
							try {
								$("#removeNote", firstIssueBox).click();
							} catch(err) {
								console.log("Resetting form - Ignoring error: " + err);
							}
						}
					});
				}
				
				//Dynamic room lookup
				function roomLookup() {
					room = $(this).val();
					
					//Ignore rooms with less than 3 characters, user is probably typing in a room
					if(room.length < 3)
						return;
					
					building = $("#building option:selected").val();
					if(building == "")
						$("#roomStatus").html("No building is selected!");
					else {
						//Need to get room info from server
						$("#roomStatus").html("Fetching info for " + building + " " + room + "...");
						$.ajaxSetup ({cache: false}); 
						$.getJSON("processData?mode=room", {building: building, room: room}, function(json) {  
							if(typeof json.error != 'undefined')
								$("#roomStatus").html("Server Error! " + json.error);
							else {
								console.log("Finished looking up room")
								$("#roomStatus").html("Success! " + json.response)
								resetForm();
								dynamicIssue.inject(json.data);
							}
						}  
					);  
					}
				}
				$("#room").live('input', roomLookup);
				
				//Automagical AJAX submit
				$("#mainForm").ajaxForm({
					//target:        '#submitStatus',   // target element(s) to be updated with server response 
					beforeSubmit: function() {
						$("#submitStatus").html("Submitting...");
					},
					success: function(data) {
						if(typeof data.error != 'undefined')
							$("#submitStatus").html("Server Error! " + data.error);
						else {
							console.log("Finished submitting form")
							$("#submitStatus").html("Success! " + data.submitStatus);
							resetForm();
						}
					},
					error: function(data) {
						$("#submitStatus").html("Javascript Error! " + data.responseText);
					},
 
					// other available options: 
					//url:       "processData?mode=form",         // override for form's 'action' attribute 
					//type:      "POST",        // 'get' or 'post', override for form's 'method' attribute 
					dataType:  'json',        // 'xml', 'script', or 'json' (expected server response type) 
					clearForm: true,        // clear all form fields after successful submit 
					resetForm: true        // reset the form after successful submit 
				});
				
				//AutoFixIt display toggle
				function toggleAutoFix() {
					if($("#modeSelect").val() == "Normal") {
						$("#autoFix").hide();
						//JQuery can't do this good apparently, so old-school time
						document.getElementById("autoFix").selectedIndex = -1;
					} else
						$("#autoFix").show();
				}
				//Show or hide based on preselected value
				toggleAutoFix();
				$('#modeSelect').change(function (e) {
					toggleAutoFix();
				});
				
				//AutoFixIt autoclosing issues
				function autoCloseIssues() {
					selectedIssues = $("#autoFix").val();
					$(".issueBox").each(function() {
						//Find any issues that should be autofixed
						if($.inArray($(this).find(".issueSelect").val(), selectedIssues) != -1) {
							setStatus($(this), "Closed");
							$(this).find(".issueStatus").html("(autofixed)")
						}
						//Find any issues that should no longer be autofixed
						else if($(this).find(".issueStatus").html() == "(autofixed)") {
							setStatus($(this), "Open")
							$(this).find(".issueStatus").html("")
						}
					})
				}
				$('#autoFix').change(autoCloseIssues);
				$(".issueSelect").change(autoCloseIssues);
				
				//Status Message
				function setStatus(issueBox, val) {
					button = issueBox.find("button");
					button.find(".statusName").text(val)
					
					//Set color based on value
					if(val == "Open")
						button.removeClass("btn-danger btn-warning btn-success").addClass("btn-danger");
					else if(val == "Waiting")
						button.removeClass("btn-danger btn-warning btn-success").addClass("btn-warning");
					else if(val == "Closed")
						button.removeClass("btn-danger btn-warning btn-success").addClass("btn-success")
				}
				$(".statusOption").click(function() {
					setStatus($(this).closest(".issueBox"), $(this).html())
				});
				
				//Since the issues elements get duplicated, readd any listeners
				function postIssueClone(clone) {
					console.log("Readding listeners to new cloned element");
					$(".statusOption", clone).click(function() {
						setStatus($(this).closest(".issueBox"), $(this).html())
					});
					$(".issueSelect").change(autoCloseIssues);
					$("#issueBox", clone).dynamicForm("#addNote", "#removeNote", {createColor:'yellow',	removeColor: 'red'});
				}
			});
		</script>
	</body>
</html>